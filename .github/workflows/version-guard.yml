name: Version Guard (api-augment, sdk, types-bundle)

on:
  pull_request:
    paths:
      - 'api-augment/**'
      - 'sdk/core/**'
      - 'sdk/msp-client/**'
      - 'sdk/package.json'
      - 'types-bundle/**'

jobs:
  check-version-bumps:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - name: Checkout PR and fetch base
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine changed package paths
        id: changes
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.sha }}"
          echo "Comparing $BASE_SHA..$HEAD_SHA"
          CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")
          echo "$CHANGED_FILES" | sed 's/^/ - /'
          NEED_CHECK_TYPES_BUNDLE=$(echo "$CHANGED_FILES" | grep -E '^types-bundle/' >/dev/null && echo true || echo false)
          NEED_CHECK_API_AUGMENT=$(echo "$CHANGED_FILES" | grep -E '^api-augment/' >/dev/null && echo true || echo false)
          NEED_CHECK_SDK=$(echo "$CHANGED_FILES" | grep -E '^sdk/(core|msp-client)/' >/dev/null && echo true || echo false)
          echo "check_types_bundle=$NEED_CHECK_TYPES_BUNDLE" >> $GITHUB_OUTPUT
          echo "check_api_augment=$NEED_CHECK_API_AUGMENT" >> $GITHUB_OUTPUT
          echo "check_sdk=$NEED_CHECK_SDK" >> $GITHUB_OUTPUT

      - name: Use Node.js
        if: steps.changes.outputs.check_types_bundle == 'true' || steps.changes.outputs.check_api_augment == 'true' || steps.changes.outputs.check_sdk == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 23

      - name: Install semver globally
        if: steps.changes.outputs.check_types_bundle == 'true' || steps.changes.outputs.check_api_augment == 'true' || steps.changes.outputs.check_sdk == 'true'
        run: |
          npm i -g semver@7
          echo "NODE_PATH=$(npm root -g)" >> $GITHUB_ENV

      - name: Verify types-bundle version bumped
        if: steps.changes.outputs.check_types_bundle == 'true'
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          CURR=$(node -p "require('./types-bundle/package.json').version")
          BASE_VER=$(git show "$BASE_SHA:types-bundle/package.json" | node -e "let s='';process.stdin.on('data',d=>s+=d).on('end',()=>{console.log(JSON.parse(s).version)})")
          echo "types-bundle base: $BASE_VER, current: $CURR"
          if [ "$CURR" = "$BASE_VER" ]; then
            echo "::error title=Version not bumped::types-bundle version is unchanged ($CURR). Please bump package.json version."
            exit 1
          fi

          # Ensure current > npm published
          NAME=$(node -p "require('./types-bundle/package.json').name")
          PUBLISHED=$(npm view "$NAME" version 2>/dev/null || echo "0.0.0")
          echo "types-bundle npm: $PUBLISHED"
          CURR="$CURR" PUBLISHED="$PUBLISHED" BASE_VER="$BASE_VER" node -e '
           const semver = require("semver");
           const curr = process.env.CURR; const pub = process.env.PUBLISHED; const base = process.env.BASE_VER;
           if (semver.eq(curr, pub)) {
             if (semver.gt(curr, base)) { process.exit(0); }
             console.log("::error title=Version not greater than npm::Current " + curr + " equals published " + pub + " and is not greater than base " + base);
             process.exit(1);
           }
           if (!semver.gt(curr, pub)) { console.log("::error title=Version not greater than npm::Current " + curr + " must be greater than published " + pub); process.exit(1); }
          '

      - name: Verify api-augment version bumped
        if: steps.changes.outputs.check_api_augment == 'true'
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          CURR=$(node -p "require('./api-augment/package.json').version")
          BASE_VER=$(git show "$BASE_SHA:api-augment/package.json" | node -e "let s='';process.stdin.on('data',d=>s+=d).on('end',()=>{console.log(JSON.parse(s).version)})")
          echo "api-augment base: $BASE_VER, current: $CURR"
          if [ "$CURR" = "$BASE_VER" ]; then
            echo "::error title=Version not bumped::api-augment version is unchanged ($CURR). Please bump package.json version."
            exit 1
          fi

          # Ensure current > npm published
          NAME=$(node -p "require('./api-augment/package.json').name")
          PUBLISHED=$(npm view "$NAME" version 2>/dev/null || echo "0.0.0")
          echo "api-augment npm: $PUBLISHED"
          CURR="$CURR" PUBLISHED="$PUBLISHED" BASE_VER="$BASE_VER" node -e '
            const semver = require("semver");
            const curr = process.env.CURR; const pub = process.env.PUBLISHED; const base = process.env.BASE_VER;
            if (semver.eq(curr, pub)) {
              if (semver.gt(curr, base)) { process.exit(0); }
              console.log("::error title=Version not greater than npm::Current " + curr + " equals published " + pub + " and is not greater than base " + base);
              process.exit(1);
            }
            if (!semver.gt(curr, pub)) { console.log("::error title=Version not greater than npm::Current " + curr + " must be greater than published " + pub); process.exit(1); }
          '

      - name: Verify SDK versions bumped (sdk root + core + msp-client)
        if: steps.changes.outputs.check_sdk == 'true'
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"

          SDK_CURR=$(node -p "require('./sdk/package.json').version")
          SDK_BASE=$(git show "$BASE_SHA:sdk/package.json" | node -e "let s='';process.stdin.on('data',d=>s+=d).on('end',()=>{console.log(JSON.parse(s).version)})")
          echo "sdk base: $SDK_BASE, current: $SDK_CURR"
          if [ "$SDK_CURR" = "$SDK_BASE" ]; then
            echo "::error title=Version not bumped::sdk/package.json version is unchanged ($SDK_CURR). Please bump it."
            exit 1
          fi

          CORE_CURR=$(node -p "require('./sdk/core/package.json').version")
          CORE_BASE=$(git show "$BASE_SHA:sdk/core/package.json" | node -e "let s='';process.stdin.on('data',d=>s+=d).on('end',()=>{console.log(JSON.parse(s).version)})")
          echo "sdk/core base: $CORE_BASE, current: $CORE_CURR"
          if [ "$CORE_CURR" = "$CORE_BASE" ]; then
            echo "::error title=Version not bumped::sdk/core/package.json version is unchanged ($CORE_CURR). Please bump it."
            exit 1
          fi

          MSP_CURR=$(node -p "require('./sdk/msp-client/package.json').version")
          MSP_BASE=$(git show "$BASE_SHA:sdk/msp-client/package.json" | node -e "let s='';process.stdin.on('data',d=>s+=d).on('end',()=>{console.log(JSON.parse(s).version)})")
          echo "sdk/msp-client base: $MSP_BASE, current: $MSP_CURR"
          if [ "$MSP_CURR" = "$MSP_BASE" ]; then
            echo "::error title=Version not bumped::sdk/msp-client/package.json version is unchanged ($MSP_CURR). Please bump it."
            exit 1
          fi

          # Ensure current > npm published (core + msp-client only; sdk root is private)
          CORE_NAME=$(node -p "require('./sdk/core/package.json').name")
          CORE_PUBLISHED=$(npm view "$CORE_NAME" version 2>/dev/null || echo "0.0.0")
          echo "sdk/core npm: $CORE_PUBLISHED"
          CURR="$CORE_CURR" PUBLISHED="$CORE_PUBLISHED" BASE_VER="$CORE_BASE" node -e '
            const semver = require("semver");
            const curr = process.env.CURR; const pub = process.env.PUBLISHED; const base = process.env.BASE_VER;
            if (semver.eq(curr, pub)) {
              if (semver.gt(curr, base)) { process.exit(0); }
              console.log("::error title=Version not greater than npm::sdk/core current " + curr + " equals published " + pub + " and is not greater than base " + base);
              process.exit(1);
            }
            if (!semver.gt(curr, pub)) {
              console.log("::error title=Version not greater than npm::sdk/core current " + curr + " must be greater than published " + pub);
              process.exit(1);
            }
          '

          MSP_NAME=$(node -p "require('./sdk/msp-client/package.json').name")
          MSP_PUBLISHED=$(npm view "$MSP_NAME" version 2>/dev/null || echo "0.0.0")
          echo "sdk/msp-client npm: $MSP_PUBLISHED"
          CURR="$MSP_CURR" PUBLISHED="$MSP_PUBLISHED" BASE_VER="$MSP_BASE" node -e '
            const semver = require("semver");
            const curr = process.env.CURR; const pub = process.env.PUBLISHED; const base = process.env.BASE_VER;
            if (semver.eq(curr, pub)) {
              if (semver.gt(curr, base)) { process.exit(0); }
              console.log("::error title=Version not greater than npm::sdk/msp-client current " + curr + " equals published " + pub + " and is not greater than base " + base);
              process.exit(1);
            }
            if (!semver.gt(curr, pub)) {
              console.log("::error title=Version not greater than npm::sdk/msp-client current " + curr + " must be greater than published " + pub);
              process.exit(1);
            }
          '

