<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MSP + SDK Web Tests</title>
  <script type="importmap">
    {
      "imports": {
        "@storagehub-sdk/msp-client": "/msp-client/dist/index.browser.js",
        "@storagehub-sdk/core": "/core/dist/index.browser.js",
        "@polkadot/types": "https://cdn.jsdelivr.net/npm/@polkadot/types@16.4.7/+esm",
        "@polkadot/types/interfaces": "https://cdn.jsdelivr.net/npm/@polkadot/types@16.4.7/interfaces/+esm",
        "ethers": "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm",
        "viem": "https://cdn.jsdelivr.net/npm/viem@2.9.20/+esm",
        "viem/accounts": "https://cdn.jsdelivr.net/npm/viem@2.9.20/accounts/+esm"
      }
    }
    </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 24px;
    }

    h1 {
      margin-bottom: 8px;
    }

    .row {
      margin: 8px 0;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    label {
      font-weight: bold;
      margin-right: 4px;
    }

    input[type="text"],
    input[type="number"] {
      padding: 6px 8px;
      min-width: 260px;
    }

    button {
      background: #0066cc;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #status {
      margin: 12px 0;
      font-weight: bold;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
    }
  </style>
</head>

<body>
  <h1>MSP + SDK Web Tests</h1>

  <div class="grid">
    <!-- Connection section -->
    <section class="card">
      <h3>1) Connection</h3>

      <div class="row">
        <label for="address">Address</label>
        <input id="address" type="text" placeholder="0x... (optional; LocalWallet used for signing)" />
        <button id="connect-msp">Connect MSP</button>
      </div>
      <div class="row">
        <div id="status" class="mono">Ready</div>
      </div>
    </section>

    <!-- Health section -->
    <section class="card">
      <h3>2) Health</h3>
      <div class="row">
        <button id="health">Get Health</button>
      </div>
      <div class="row">
        <div><strong>Health:</strong> <span id="healthStatus" class="mono"></span></div>
      </div>
      <div class="row">
        <div><strong>Response:</strong></div>
      </div>
      <pre id="healthJson" class="mono" style="white-space: pre-wrap; word-break: break-word;"></pre>
    </section>

    <!-- Auth section -->
    <section class="card">
      <h3>3) Auth</h3>
      <div class="row">
        <button id="siwe-auth">SIWE</button>
      </div>
      <div class="row">
        <div><strong>Auth Status:</strong> <span id="authStatus" class="mono"></span></div>
      </div>
    </section>

    <!-- Transfer section -->
    <section class="card">
      <h3>4) Transfer</h3>
      <div class="row">
        <button id="upload">Upload adolphus.jpg</button>
      </div>
      <div class="row">
        <button id="download-key">Download by Key</button>
      </div>
      <div class="row">
        <div><strong>Upload Receipt:</strong> <span id="uploadReceipt" class="mono"></span></div>
      </div>
      <div class="row">
        <div><strong>Download Meta:</strong> <span id="downloadMeta" class="mono"></span></div>
      </div>
    </section>

    <!-- Buckets section -->
    <section class="card">
      <h3>5) Buckets</h3>
      <div class="row">
        <button id="list-buckets">List Buckets</button>
        <input id="bucketIdInput" type="text" placeholder="bucket id (optional uses first)" />
        <button id="get-bucket">Get Bucket</button>
        <input id="pathInput" type="text" placeholder="path (e.g., Thesis or Reports)" />
        <button id="get-files">Get Files</button>
      </div>
      <div class="row">
        <div><strong>Buckets Count:</strong> <span id="bucketsCount" class="mono"></span></div>
      </div>
      <div class="row">
        <div><strong>Last Bucket:</strong> <span id="bucketJson" class="mono"></span></div>
      </div>
      <div class="row">
        <div><strong>File Tree:</strong></div>
      </div>
      <pre id="filesJson" class="mono" style="white-space: pre-wrap; word-break: break-word;"></pre>
    </section>

    <!-- MSP Info section -->
    <section class="card">
      <h3>6) MSP Info</h3>
      <div class="row">
        <button id="get-info">Get Info</button>
        <button id="get-stats">Get Stats</button>
        <button id="get-value-props">Get Value Props</button>
        <button id="get-payment-streams">Get Payment Streams</button>
      </div>
      <div class="row">
        <div><strong>Info:</strong></div>
      </div>
      <pre id="infoJson" class="mono" style="white-space: pre-wrap; word-break: break-word;"></pre>
      <div class="row">
        <div><strong>Stats:</strong></div>
      </div>
      <pre id="statsJson" class="mono" style="white-space: pre-wrap; word-break: break-word;"></pre>
      <div class="row">
        <div><strong>Value Props:</strong></div>
      </div>
      <pre id="valuePropsJson" class="mono" style="white-space: pre-wrap; word-break: break-word;"></pre>
      <div class="row">
        <div><strong>Payment Streams:</strong></div>
      </div>
      <pre id="paymentStreamsJson" class="mono" style="white-space: pre-wrap; word-break: break-word;"></pre>
    </section>

    <!-- File Info section -->
    <section class="card">
      <h3>7) File Info</h3>
      <div class="row">
        <input id="bucketInfoIdInput" type="text" placeholder="bucket id"
          value="d8793e4187f5642e96016a96fb33849a7e03eda91358b311bbd426ed38b26692" />
        <input id="fileKeyInput" type="text" placeholder="file key"
          value="e901c8d212325fe2f18964fd2ea6e7375e2f90835b638ddb3c08692edd7840f7" />
        <button id="get-file-info">Get File Info</button>
      </div>
      <div class="row">
        <div><strong>File Info:</strong></div>
      </div>
      <pre id="fileInfoJson" class="mono" style="white-space: pre-wrap; word-break: break-word;"></pre>
    </section>

    <!-- Errors -->
    <section class="card">
      <h3>Errors</h3>
      <div class="row">
        <div><strong>Error:</strong> <span id="error" class="mono"></span></div>
      </div>
    </section>
  </div>

  <script>
    // Page state for Playwright assertions
    window.__msp = { status: undefined, nonce: undefined, message: undefined, signature: undefined, token: undefined, user: undefined, uploadReceipt: undefined, downloadMeta: undefined, error: undefined, buckets: undefined, lastBucket: undefined, files: undefined, info: undefined, stats: undefined, valueProps: undefined, fileInfo: undefined };

    const statusEl = document.getElementById('status');
    const setStatus = (t) => { statusEl.textContent = t; };
    const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = typeof v === 'string' ? v : JSON.stringify(v); };

    let client = null;
    let connectedBaseUrl = null;
    let sessionRef = undefined;

    function toBase64Url(str) {
      return btoa(unescape(encodeURIComponent(str)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/g, '');
    }

    async function loadAdolphusBlob() {
      const candidates = ['/e2e/page/adolphus.jpg', '/docker/resource/adolphus.jpg'];
      for (const url of candidates) {
        try {
          const r = await fetch(url);
          if (r.ok) return await r.blob();
        } catch (_) { }
      }
      // Fallback: generate a small dummy JPEG-like blob
      const bytes = new Uint8Array(1024).fill(65);
      return new Blob([bytes], { type: 'image/jpeg' });
    }

    async function ensureConnected() {
      const baseUrl = 'http://127.0.0.1:8080';
      if (client && connectedBaseUrl === baseUrl) return client;
      const { MspClient } = await import('@storagehub-sdk/msp-client');
      const sessionProvider = async () => sessionRef;
      client = await MspClient.connect({ baseUrl, timeoutMs: 60000 }, sessionProvider);
      connectedBaseUrl = baseUrl;
      return client;
    }

    // Optional: initialize WASM (for core types if needed by the browser)
    (async () => {
      try {
        const { initWasm } = await import('@storagehub-sdk/core');
        await initWasm();
        console.log('WASM ready');
      } catch (e) {
        console.warn('WASM init skipped/failed', e);
      }
    })();

    document.getElementById('connect-msp').onclick = async () => {
      try {
        setStatus('Connecting MSP...');
        await ensureConnected();
        setStatus('MSP connected');
      } catch (e) {
        setStatus('Connect failed');
        window.__msp.error = e?.message || String(e);
        setText('error', window.__msp.error);
      }
    };

    document.getElementById('health').onclick = async () => {
      try {
        await ensureConnected();
        setStatus('Health...');
        const h = await client.info.getHealth();
        window.__msp.status = h?.status;
        window.__msp.health = h;
        console.log('[HEALTH]', h);
        setStatus(`Health: ${h.status}`);
      } catch (e) {
        setStatus('Health failed');
        window.__msp.error = e?.message || String(e);
        console.error('[HEALTH][ERROR]', e);
      }
    };

    document.getElementById('siwe-auth').onclick = async () => {
      try {
        await ensureConnected();
        setStatus('Authenticating (SIWE)...');
        const { createWalletClient, custom } = await import('viem');
        const { privateKeyToAccount } = await import('viem/accounts');

        // Deterministic dev key (Hardhat default first account)
        const account = privateKeyToAccount('0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80');

        // Minimal transport: only eth_chainId is needed by authenticateSIWE
        const wallet = createWalletClient({
          account,
          transport: custom({
            async request({ method }) {
              if (method === 'eth_chainId') return '0x2c3e6'; // 181222
              throw new Error('Unsupported JSON-RPC method in test transport');
            }
          })
        });

        const session = await client.auth.SIWE(wallet);
        sessionRef = session;
        // Consider authenticated if session now exists and profile fetch succeeds
        await client.auth.getProfile();
        window.__msp.status = 'Authenticated';
        setText('authStatus', 'Authenticated');
        console.log('[SIWE]', 'Authenticated');
        setStatus('Authenticated');
      } catch (e) {
        setStatus('SIWE failed');
        window.__msp.error = e?.message || String(e);
        console.error('[SIWE][ERROR]', e);
      }
    };

    document.getElementById('upload').onclick = async () => {
      try {
        if (!client) throw new Error('Connect MSP first');
        setStatus('Uploading...');
        // Ensure we still have a valid session/profile
        await client.auth.getProfile();
        const owner = '0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266';
        const bucketId = '0xd8793e4187f5642e96016a96fb33849a7e03eda91358b311bbd426ed38b26692';
        const adolphusFingerprint = client.files.hexToBytes('0x34eb5f637e05fc18f857ccb013250076534192189894d174ee3aa6d3525f6970');
        const location = 'files/e2e-bucket/adolphus.jpg';
        const blob = await loadAdolphusBlob();
        const metadata = await client.files.formFileMetadata(owner, bucketId, location, adolphusFingerprint, BigInt(blob.size));
        const fileKey = '0x' + Array.from(await client.files.computeFileKey(metadata)).map(b => b.toString(16).padStart(2, '0')).join('');
        const receipt = await client.files.uploadFile(bucketId, fileKey, blob, owner, location);
        window.__msp.uploadReceipt = receipt;
        console.log('[UPLOAD][RECEIPT]', receipt);
        setStatus('Upload done');
      } catch (e) {
        setStatus('Upload failed');
        window.__msp.error = e?.message || String(e);
        console.error('[UPLOAD][ERROR]', e);
      }
    };

    document.getElementById('download-key').onclick = async () => {
      try {
        if (!client) throw new Error('Connect MSP first');
        setStatus('Downloading by key...');
        const fileKey = '0xc4344065c2f4c1155008caf5d56bcbf59d2f37b276e566b2dcad4713904d88e8';
        await client.auth.getProfile();
        const dl = await client.files.downloadFile(fileKey);
        window.__msp.downloadMeta = { status: dl?.status, contentType: dl?.contentType, contentLength: dl?.contentLength, contentRange: dl?.contentRange };
        console.log('[DOWNLOAD][KEY][META]', window.__msp.downloadMeta);
        // Save to user-selected location (browsers cannot write to /tmp)
        const blob = await new Response(dl.stream).blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileKey;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        setStatus('Download (key) done');
      } catch (e) {
        setStatus('Download (key) failed');
        window.__msp.error = e?.message || String(e);
        console.error('[DOWNLOAD][KEY][ERROR]', e);
      }
    };



    // Buckets
    document.getElementById('list-buckets').onclick = async () => {
      try {
        if (!client) throw new Error('Connect MSP first');
        setStatus('Listing buckets...');
        await client.auth.getProfile();
        const buckets = await client.buckets.listBuckets();
        window.__msp.buckets = buckets;
        document.getElementById('bucketsCount').textContent = String(buckets.length);
        console.log('[BUCKETS][LIST]', buckets);
        setStatus('Buckets listed');
      } catch (e) {
        setStatus('List buckets failed');
        window.__msp.error = e?.message || String(e);
        console.error('[BUCKETS][LIST][ERROR]', e);
      }
    };

    async function getSelectedBucketId() {
      const input = document.getElementById('bucketIdInput');
      const val = input && typeof input.value === 'string' ? input.value.trim() : '';
      if (val) return val;
      if (Array.isArray(window.__msp.buckets) && window.__msp.buckets.length > 0) return window.__msp.buckets[0].bucketId;
      return 'e2e-bucket';
    }

    document.getElementById('get-bucket').onclick = async () => {
      try {
        if (!client) throw new Error('Connect MSP first');
        setStatus('Getting bucket...');
        await client.auth.getProfile();
        const bucketId = await getSelectedBucketId();
        const bucket = await client.buckets.getBucket(bucketId);
        window.__msp.lastBucket = bucket;
        document.getElementById('bucketJson').textContent = JSON.stringify(bucket);
        console.log('[BUCKETS][GET]', bucket);
        setStatus('Bucket loaded');
      } catch (e) {
        setStatus('Get bucket failed');
        window.__msp.error = e?.message || String(e);
        console.error('[BUCKETS][GET][ERROR]', e);
      }
    };

    document.getElementById('get-files').onclick = async () => {
      try {
        if (!client) throw new Error('Connect MSP first');
        setStatus('Getting files...');
        await client.auth.getProfile();
        const bucketId = await getSelectedBucketId();
        const pathEl = document.getElementById('pathInput');
        const pathVal = pathEl && typeof pathEl.value === 'string' ? pathEl.value.trim() : '';
        const files = await client.buckets.getFiles(bucketId, pathVal ? { path: pathVal } : undefined);
        window.__msp.files = files;
        document.getElementById('filesJson').textContent = JSON.stringify(files, null, 2);
        console.log('[BUCKETS][FILES]', files);
        setStatus('Files loaded');
      } catch (e) {
        setStatus('Get files failed');
        window.__msp.error = e?.message || String(e);
        console.error('[BUCKETS][FILES][ERROR]', e);
      }
    };

    // MSP Info handlers
    document.getElementById('get-info').onclick = async () => {
      try {
        await ensureConnected();
        setStatus('Getting info...');
        const info = await client.info.getInfo();
        window.__msp.info = info;
        document.getElementById('infoJson').textContent = JSON.stringify(info, null, 2);
        console.log('[MSP][INFO]', info);
        setStatus('Info loaded');
      } catch (e) {
        setStatus('Get info failed');
        window.__msp.error = e?.message || String(e);
        console.error('[MSP][INFO][ERROR]', e);
      }
    };

    document.getElementById('get-stats').onclick = async () => {
      try {
        await ensureConnected();
        setStatus('Getting stats...');
        const stats = await client.info.getStats();
        window.__msp.stats = stats;
        document.getElementById('statsJson').textContent = JSON.stringify(stats, null, 2);
        console.log('[MSP][STATS]', stats);
        setStatus('Stats loaded');
      } catch (e) {
        setStatus('Get stats failed');
        window.__msp.error = e?.message || String(e);
        console.error('[MSP][STATS][ERROR]', e);
      }
    };

    document.getElementById('get-value-props').onclick = async () => {
      try {
        await ensureConnected();
        setStatus('Getting value props...');
        const valueProps = await client.info.getValuePropositions();
        window.__msp.valueProps = valueProps;
        document.getElementById('valuePropsJson').textContent = JSON.stringify(valueProps, null, 2);
        console.log('[MSP][VALUE-PROPS]', `count=${Array.isArray(valueProps) ? valueProps.length : 0}`, JSON.stringify(valueProps, null, 2));
        setStatus('Value props loaded');
      } catch (e) {
        setStatus('Get value props failed');
        window.__msp.error = e?.message || String(e);
        console.error('[MSP][VALUE-PROPS][ERROR]', e);
      }
    };

    document.getElementById('get-payment-streams').onclick = async () => {
      try {
        await ensureConnected();
        setStatus('Getting payment streams...');
        const streams = await client.info.getPaymentStreams();
        window.__msp.paymentStreams = streams;
        document.getElementById('paymentStreamsJson').textContent = JSON.stringify(streams, null, 2);
        console.log('[PAYMENT][STREAMS]', JSON.stringify(streams));
        setStatus('Payment streams loaded');
      } catch (e) {
        setStatus('Get payment streams failed');
        window.__msp.error = e?.message || String(e);
        console.error('[PAYMENT][STREAMS][ERROR]', e);
      }
    };

    document.getElementById('get-file-info').onclick = async () => {
      try {
        await ensureConnected();
        setStatus('Getting file info...');
        await client.auth.getProfile();
        const bucketEl = document.getElementById('bucketInfoIdInput');
        const fileKeyEl = document.getElementById('fileKeyInput');
        const bucketId = bucketEl && typeof bucketEl.value === 'string' && bucketEl.value.trim() ? bucketEl.value.trim() : 'd8793e4187f5642e96016a96fb33849a7e03eda91358b311bbd426ed38b26692';
        const fileKey = fileKeyEl && typeof fileKeyEl.value === 'string' && fileKeyEl.value.trim() ? fileKeyEl.value.trim() : 'e901c8d212325fe2f18964fd2ea6e7375e2f90835b638ddb3c08692edd7840f7';
        const info = await client.files.getFileInfo(bucketId, fileKey);
        window.__msp.fileInfo = info;
        document.getElementById('fileInfoJson').textContent = JSON.stringify(info, null, 2);
        console.log('[MSP][FILE-INFO]', info);
        setStatus('File info loaded');
      } catch (e) {
        setStatus('Get file info failed');
        window.__msp.error = e?.message || String(e);
        console.error('[MSP][FILE-INFO][ERROR]', e);
      }
    };
  </script>
</body>

</html>
