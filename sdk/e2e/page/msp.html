<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSP + SDK Web Tests</title>
    <script type="importmap">
    {
      "imports": {
        "@storagehub-sdk/msp-client": "/msp-client/dist/index.js",
        "@storagehub-sdk/core": "/core/dist/index.js",
        "@storagehub/wasm": "/core/wasm/pkg/storagehub_wasm.js",
        "ethers": "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm"
      }
    }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 24px;
        }

        h1 {
            margin-bottom: 8px;
        }

        .row {
            margin: 8px 0;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        label {
            font-weight: bold;
            margin-right: 4px;
        }

        input[type="text"],
        input[type="number"] {
            padding: 6px 8px;
            min-width: 260px;
        }

        button {
            background: #0066cc;
            color: #fff;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #status {
            margin: 12px 0;
            font-weight: bold;
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
        }
    </style>
</head>

<body>
    <h1>MSP + SDK Web Tests</h1>

    <div class="grid">
        <!-- Connection section -->
        <section class="card">
            <h3>1) Connection</h3>
            <div class="row">
                <label for="baseUrl">Base URL</label>
                <input id="baseUrl" type="text" value="http://127.0.0.1:8080" />
                <label for="chainId">Chain ID</label>
                <input id="chainId" type="number" value="1" />
            </div>
            <div class="row">
                <label for="address">Address</label>
                <input id="address" type="text" placeholder="0x... (optional; LocalWallet used for signing)" />
                <button id="connect-msp">Connect MSP</button>
            </div>
            <div class="row">
                <div id="status" class="mono">Ready</div>
            </div>
        </section>

        <!-- Health section -->
        <section class="card">
            <h3>2) Health</h3>
            <div class="row">
                <button id="health">Get Health</button>
            </div>
            <div class="row">
                <div><strong>Health:</strong> <span id="healthStatus" class="mono"></span></div>
            </div>
            <div class="row">
                <div><strong>Response:</strong></div>
            </div>
            <pre id="healthJson" class="mono" style="white-space: pre-wrap; word-break: break-word;"></pre>
        </section>

        <!-- Auth section -->
        <section class="card">
            <h3>3) Auth</h3>
            <div class="row">
                <button id="get-nonce">Get Nonce</button>
                <button id="sign-message">Sign Message</button>
                <button id="verify">Verify (set token)</button>
            </div>
            <div class="row">
                <div><strong>Nonce:</strong> <span id="nonce" class="mono"></span></div>
            </div>
            <div class="row">
                <div><strong>Message:</strong> <span id="message" class="mono"></span></div>
            </div>
            <div class="row">
                <div><strong>Nonce Response:</strong></div>
            </div>
            <pre id="nonceJson" class="mono" style="white-space: pre-wrap; word-break: break-word;"></pre>
            <div class="row">
                <div><strong>Signature:</strong> <span id="signature" class="mono"></span></div>
            </div>
            <div class="row">
                <div><strong>Sign Response:</strong></div>
            </div>
            <pre id="signJson" class="mono" style="white-space: pre-wrap; word-break: break-word;"></pre>
            <div class="row">
                <div><strong>Token:</strong> <span id="token" class="mono"></span></div>
            </div>
            <div class="row">
                <div><strong>User:</strong> <span id="user" class="mono"></span></div>
            </div>
            <div class="row">
                <div><strong>Verify Response:</strong></div>
            </div>
            <pre id="verifyJson" class="mono" style="white-space: pre-wrap; word-break: break-word;"></pre>
        </section>

        <!-- Transfer section -->
        <section class="card">
            <h3>4) Transfer</h3>
            <div class="row">
                <label for="bucketId">Bucket</label>
                <input id="bucketId" type="text" value="e2e-bucket" />
                <label for="fileKey">File Key</label>
                <input id="fileKey" type="text" value="web-file" />
            </div>
            <div class="row">
                <input id="fileInput" type="file" />
                <button id="upload">Upload File</button>
            </div>
            <div class="row">
                <label for="path">Path</label>
                <input id="path" type="text" placeholder="path/to/file" />
                <button id="download-key">Download by Key</button>
                <button id="download-path">Download by Path</button>
            </div>
            <div class="row">
                <div><strong>Upload Receipt:</strong> <span id="uploadReceipt" class="mono"></span></div>
            </div>
            <div class="row">
                <div><strong>Download Meta:</strong> <span id="downloadMeta" class="mono"></span></div>
            </div>
        </section>

        <!-- Errors -->
        <section class="card">
            <h3>Errors</h3>
            <div class="row">
                <div><strong>Error:</strong> <span id="error" class="mono"></span></div>
            </div>
        </section>
    </div>

    <script>
        // Page state for Playwright assertions
        window.__msp = { status: undefined, nonce: undefined, message: undefined, signature: undefined, token: undefined, user: undefined, uploadReceipt: undefined, downloadMeta: undefined, error: undefined };

        const statusEl = document.getElementById('status');
        const setStatus = (t) => { statusEl.textContent = t; };
        const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = typeof v === 'string' ? v : JSON.stringify(v); };

        let client = null;
        let connectedBaseUrl = null;

        async function ensureConnected() {
            const baseUrl = document.getElementById('baseUrl').value.trim();
            if (client && connectedBaseUrl === baseUrl) return client;
            const { MspClient } = await import('/msp-client/dist/index.js');
            client = await MspClient.connect({ baseUrl, timeoutMs: 60000 });
            connectedBaseUrl = baseUrl;
            return client;
        }

        // Optional: initialize WASM (for core types if needed by the browser)
        (async () => {
            try {
                const initWasm = (await import('/core/wasm/pkg/storagehub_wasm.js')).default;
                await initWasm();
                console.log('WASM ready');
            } catch (e) {
                console.warn('WASM init skipped/failed', e);
            }
        })();

        document.getElementById('connect-msp').onclick = async () => {
            try {
                setStatus('Connecting MSP...');
                await ensureConnected();
                setStatus('MSP connected');
            } catch (e) {
                setStatus('Connect failed');
                window.__msp.error = e?.message || String(e);
                setText('error', window.__msp.error);
            }
        };

        document.getElementById('health').onclick = async () => {
            try {
                await ensureConnected();
                setStatus('Health...');
                const h = await client.getHealth();
                window.__msp.status = h?.status;
                window.__msp.health = h;
                setText('healthStatus', window.__msp.status || '');
                const hj = document.getElementById('healthJson');
                if (hj) hj.textContent = JSON.stringify(h, null, 2);
                setStatus(`Health: ${h?.status || 'unknown'}`);
            } catch (e) {
                setStatus('Health failed');
                window.__msp.error = e?.message || String(e);
                setText('error', window.__msp.error);
                const hj = document.getElementById('healthJson');
                if (hj) hj.textContent = '';
            }
        };

        document.getElementById('get-nonce').onclick = async () => {
            try {
                await ensureConnected();
                setStatus('Requesting nonce...');
                let address = document.getElementById('address').value.trim();
                const chainId = Number(document.getElementById('chainId').value || 1);
                // Auto-fill a valid address if none/invalid is provided
                const isValidEth = /^0x[a-fA-F0-9]{40}$/.test(address);
                if (!isValidEth) {
                    const { LocalWallet } = await import('/core/dist/index.js');
                    const wallet = LocalWallet.fromMnemonic('test test test test test test test test test test test junk');
                    address = await wallet.getAddress();
                    const addrInput = document.getElementById('address');
                    if (addrInput) addrInput.value = address;
                }
                const res = await client.getNonce(address, chainId);
                const { message, nonce } = res;
                window.__msp.message = message; window.__msp.nonce = nonce; window.__msp.nonceResponse = res;
                setText('message', message); setText('nonce', nonce);
                const nj = document.getElementById('nonceJson');
                if (nj) nj.textContent = JSON.stringify(res, null, 2);
                setStatus('Nonce ready');
            } catch (e) {
                setStatus('Get nonce failed');
                window.__msp.error = e?.message || String(e);
                setText('error', window.__msp.error);
                const nj = document.getElementById('nonceJson');
                if (nj) nj.textContent = '';
            }
        };

        document.getElementById('sign-message').onclick = async () => {
            try {
                setStatus('Signing message...');
                const msg = window.__msp.message;
                if (!msg) throw new Error('No message to sign. Click Get Nonce first.');
                const { LocalWallet } = await import('/core/dist/index.js');
                const wallet = LocalWallet.fromMnemonic('test test test test test test test test test test test junk');
                const address = await wallet.getAddress();
                const sig = await wallet.signMessage(msg);
                window.__msp.signature = sig;
                window.__msp.signResponse = { address, message: msg, signature: sig };
                setText('signature', sig);
                const sj = document.getElementById('signJson');
                if (sj) sj.textContent = JSON.stringify(window.__msp.signResponse, null, 2);
                setStatus('Signed');
            } catch (e) {
                setStatus('Sign failed');
                window.__msp.error = e?.message || String(e);
                setText('error', window.__msp.error);
                const sj = document.getElementById('signJson');
                if (sj) sj.textContent = '';
            }
        };

        document.getElementById('verify').onclick = async () => {
            try {
                await ensureConnected();
                setStatus('Verifying...');
                const { message, signature } = window.__msp;
                if (!message || !signature) throw new Error('Need message and signature.');
                const res = await client.verify(message, signature);
                const { token, user } = res;
                window.__msp.token = token; window.__msp.user = user;
                client.setToken(token);
                setText('token', token); setText('user', user);
                const vj = document.getElementById('verifyJson');
                if (vj) vj.textContent = JSON.stringify(res, null, 2);
                setStatus('Verified / token set');
            } catch (e) {
                setStatus('Verify failed');
                window.__msp.error = e?.message || String(e);
                setText('error', window.__msp.error);
                const vj = document.getElementById('verifyJson');
                if (vj) vj.textContent = '';
            }
        };

        document.getElementById('upload').onclick = async () => {
            try {
                if (!client) throw new Error('Connect MSP first');
                setStatus('Uploading...');
                const bucketId = document.getElementById('bucketId').value.trim();
                const fileKey = document.getElementById('fileKey').value.trim() || `web-${Date.now()}`;
                const f = document.getElementById('fileInput').files?.[0];
                if (!f) throw new Error('Pick a file first.');
                const receipt = await client.uploadFile(bucketId, fileKey, f);
                window.__msp.uploadReceipt = receipt;
                setText('uploadReceipt', receipt);
                setStatus('Upload done');
            } catch (e) {
                setStatus('Upload failed');
                window.__msp.error = e?.message || String(e);
                setText('error', window.__msp.error);
            }
        };

        document.getElementById('download-key').onclick = async () => {
            try {
                if (!client) throw new Error('Connect MSP first');
                setStatus('Downloading by key...');
                const bucketId = document.getElementById('bucketId').value.trim();
                const fileKey = document.getElementById('fileKey').value.trim();
                const dl = await client.downloadByKey(bucketId, fileKey);
                window.__msp.downloadMeta = { status: dl?.status, contentType: dl?.contentType, contentLength: dl?.contentLength, contentRange: dl?.contentRange };
                setText('downloadMeta', window.__msp.downloadMeta);
                setStatus('Download (key) done');
            } catch (e) {
                setStatus('Download (key) failed');
                window.__msp.error = e?.message || String(e);
                setText('error', window.__msp.error);
            }
        };

        document.getElementById('download-path').onclick = async () => {
            try {
                if (!client) throw new Error('Connect MSP first');
                setStatus('Downloading by path...');
                const bucketId = document.getElementById('bucketId').value.trim();
                const path = document.getElementById('path').value.trim();
                const dl = await client.downloadByLocation(bucketId, path);
                window.__msp.downloadMeta = { status: dl?.status, contentType: dl?.contentType, contentLength: dl?.contentLength, contentRange: dl?.contentRange };
                setText('downloadMeta', window.__msp.downloadMeta);
                setStatus('Download (path) done');
            } catch (e) {
                setStatus('Download (path) failed');
                window.__msp.error = e?.message || String(e);
                setText('error', window.__msp.error);
            }
        };
    </script>
</body>

</html>